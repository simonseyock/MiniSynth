window.synth=window.synth||{},function(){var t=window.synth;t.inherits=function(t,e){jQuery.extend(t.prototype,e.prototype)},t.abstractFunction=function(){throw new Error("You tried to call an abstract function. Yuck.")},t.StateExchange=function(){this.state_={}},t.StateExchange.stateExchangeFactory_={prototypes:[],addType:function(t,e){this.prototypes[t]=e},createObject:function(t){return t in this.prototypes?new this.prototypes[t]:{}}},t.StateExchange.addType=function(e,i){t.StateExchange.stateExchangeFactory_.addType(e,i)},t.StateExchange.prototype.addNormalStateParameter=function(t,e,i){this.state_[t]={get:e,set:i}},t.StateExchange.prototype.addExchangeObjectStateParameter=function(e,i,n){this.state_[e]={get:function(){return{type:i().typeName,state:i().getState()}},set:function(e){var i=t.StateExchange.stateExchangeFactory_.createObject(e.typeName);i.setState(e.state),n(i)}}},t.StateExchange.prototype.addExchangeObjectArrayStateParameter=function(e,i,n){this.state_[e]={get:function(){for(var t=[],e=i(),n=0;e.length;n++)t.push({type:e[n].typeName,state:e.getState()});return t},set:function(e){for(var i=[],s=0;e.length;s++)i.push(t.StateExchange.stateExchangeFactory_.createObject(e[s].typeName));obj.setState(typedState.state),n(obj)}}},t.StateExchange.prototype.getState=function(t){if(t)return this.state_[t].get();var e={};for(var i in this.state_)e[i]=this.state_.get();return e},t.StateExchange.prototype.setState=function(t,e){if(1===arguments.length&&(e=arguments[0],t=void 0),t)this.state_[t].set(e);else for(key in e)this.state_[key].set(e[key])},t.instrument=t.instrument||{},t.instrument.Instrument=function(e,i){t.StateExchange.call(this),this.audioContext_=e,this.frequenciesToPlay=new t.TimeCollection(0,0),this.frequencyTable_=i},t.inherits(t.instrument.Instrument,t.StateExchange),t.StateExchange.addType("synth.instrument.Instrument",t.instrument.Instrument),t.instrument.Instrument.prototype.addFrequency=function(t){this.frequenciesToPlay.insert(t);var e=this.audioContext_.currentTime;this.frequenciesToPlay.before(e,!1).forEach(function(t){t.time+t.duration<e&&this.frequenciesToPlay.remove(t)}.bind(this))},t.instrument.Instrument.prototype.addFrequencies=function(t){t.forEach(function(t){this.addFrequency(t)}.bind(this))},t.instrument.Instrument.prototype.addNote=function(t){var e=_.cloneDeep(t);e.value=this.frequencyTable_[t.value],this.addFrequency(e)},t.instrument.Instrument.prototype.addNotes=function(t){t.forEach(function(t){this.addNote(t)}.bind(this))},t.instrument.Instrument.prototype.removeFrequency=function(t){this.frequenciesToPlay.remove(t)},t.instrument.Instrument.prototype.removeFrequencies=function(t){t.forEach(function(t){this.removeFrequency(t)}.bind(this))},t.instrument.Instrument.prototype.removeNote=function(t){_.cloneDeep(t);t.value=this.frequencyTable_[t.value],this.removeFrequency(t)},t.instrument.Instrument.prototype.removeNotes=function(t){t.forEach(function(t){this.removeNote(t)}.bind(this))},t.instrument.Instrument.prototype.changeTempo=function(t,e){this.frequenciesToPlay.atTime(e).forEach(function(i){var n=(i.time+i.duration-e)*t,s=e-i.time;i.duration=s+n}),this.frequenciesToPlay.after(e,!1).forEach(function(i){i.time=(i.time-e)*t+e,i.duration*=t}.bind(this))},t.instrument.Instrument.prototype.connect=t.abstractFunction,t.instrument.Instrument.prototype.interrupt=t.abstractFunction,t.instrument.ModularSynth=function(e,i){t.instrument.Instrument.call(this,e,i),this.modules_=[]},t.inherits(t.instrument.ModularSynth,t.instrument.Instrument),t.instrument.ModularSynth.prototype.addModule=function(t){this.modules_.push(t),t.watch&&t.watch(this.frequenciesToPlay)},t.instrument.ModularSynth.prototype.pause=function(t){this.modules_.forEach(function(e){e.pause&&e.pause(t)}.bind(this))},t.instrument.ModularSynth.prototype.interrupt=function(){this.modules_.forEach(function(t){t.interrupt&&t.interrupt()}.bind(this))},t.instrument.ModularSynth.prototype.changeTempo=function(e,i){t.instrument.Instrument.prototype.changeTempo.call(this,e,i),this.modules_.forEach(function(t){t.updateTiming&&t.updateTiming(i)}.bind(this))},t=t||{},t.module=t.module||{},t.module.Module=function(t){this.audioContext_=t,this.input=null,this.output=null},t.module.Module.prototype.connect=function(t){t.hasOwnProperty("input")?this.connect(t.input):this.output.connect(t)},function(){var i=function(t,e,i,n){this.audioContext_=t,this.waveType_=i||"sine",this.timeObject=e,this.envelope_=n||{attack:0,decay:0,sustain:1,release:0},this.oscillator_=null,this.envelopeShaper_=t.createGain(),this.createOscillator_(),this.oscillator_.connect(this.envelopeShaper_),this.updateTiming(),this.output=this.envelopeShaper_};t.inherits(i,t.module.Module),i.prototype.createOscillator_=function(){this.oscillator_&&(this.oscillator_.stop(0),this.oscillator_.disconnect()),this.oscillator_=this.audioContext_.createOscillator(),this.oscillator_.frequency.value=this.timeObject.value,this.oscillator_.type=this.waveType_,this.oscillator_.connect(this.envelopeShaper_),this.audioContext_.currentTime<this.timeObject.time+this.timeObject.duration&&(this.realEndTime_=this.timeObject.time+this.timeObject.duration+this.envelope_.release,this.startTime_=this.audioContext_.currentTime<this.timeObject.time?this.timeObject.time:this.audioContext_.currentTime,this.oscillator_.start(this.startTime_),this.oscillator_.stop(this.realEndTime_),this.started_=!0)},i.prototype.shapeEnvelope_=function(){var t=this.audioContext_.currentTime,e=this.timeObject.time+this.timeObject.duration;this.envelopeShaper_.gain.cancelScheduledValues(t);var i=!1,n=!1;if(t<=e+this.envelope_.release){if(e>=t){if(t<=this.startTime_+this.envelope_.attack+this.envelope_.decay){if(t<=this.startTime_+this.envelope_.attack)if(t<=this.startTime_&&this.envelopeShaper_.gain.setValueAtTime(0,this.startTime_),this.startTime_+this.envelope_.attack<=e)this.envelopeShaper_.gain.linearRampToValueAtTime(1,this.startTime_+this.envelope_.attack),i=!0;else{var s=(e-this.startTime_)/this.envelope_.attack;this.envelopeShaper_.gain.linearRampToValueAtTime(s,e),i=!1}if(i)if(this.startTime_+this.envelope_.attack+this.envelope_.decay<=e)this.envelopeShaper_.gain.linearRampToValueAtTime(this.envelope_.sustain,this.startTime_+this.envelope_.attack+this.envelope_.decay),n=!0;else{var s=(e-this.startTime_-this.envelope_.attack)/this.envelope_.decay;this.envelopeShaper_.gain.linearRampToValueAtTime(s*this.envelope_.sustain,e),n=!1}}i&&n&&this.envelopeShaper_.gain.setValueAtTime(this.envelope_.sustain,e)}this.envelopeShaper_.gain.linearRampToValueAtTime(0,e+this.envelope_.release)}},i.prototype.updateTiming=function(){this.startTime_=this.timeObject.time,this.realEndTime_=this.timeObject.time+this.timeObject.duration+this.envelope_.release,this.audioContext_.currentTime<=this.startTime_?this.createOscillator_():this.started_&&this.oscillator_.stop(this.realEndTime_),this.shapeEnvelope_()},i.prototype.isFinished=function(){return this.audioContext_.currentTime>this.realEndTime_},i.prototype.setWaveType=function(t){this.waveType_=t,this.oscillator_.type=t},i.prototype.dispose=function(t){var e=function(){this.oscillator_&&(this.oscillator_.stop(this.audioContext_.currentTime),this.oscillator_.disconnect(),this.oscillator_=null),this.envelopeShaper_&&(this.envelopeShaper_.gain.cancelScheduledValues(this.audioContext_.currentTime),this.envelopeShaper_.disconnect(),this.envelopeShaper_=null),this.output=null,this.started_=!1}.bind(this);t?e():(this.started_&&(this.oscillator_.stop(this.audioContext_.currentTime+this.envelope_.release),this.envelopeShaper_.gain.cancelScheduledValues(this.audioContext_.currentTime),this.envelopeShaper_.gain.linearRampToValueAtTime(0,this.audioContext_.currentTime+this.envelope_.release)),setTimeout(e,1e3*this.envelope_.release))},t.module.SoundGenerator=function(t,e){this.audioContext_=t,e=e||{},this.gain_=t.createGain(),this.waveType_=e.waveType||"sine",this.singleSoundGenerators_=[],this.envelope_=e.envelope||{attack:0,decay:0,sustain:1,release:0},this.setGain(e.gain||1),this.output=this.gain_},t.inherits(t.module.SoundGenerator,t.module.Module),t.module.SoundGenerator.prototype.disposeFinishedSingleSoundGenerators_=function(){for(var t=this.singleSoundGenerators_.length-1;t>=0;t--)this.singleSoundGenerators_[t].isFinished()&&(this.singleSoundGenerators_[t].dispose(!0),this.singleSoundGenerators_.splice(t,1))},t.module.SoundGenerator.prototype.watch=function(t){t.on("insert",function(t){this.disposeFinishedSingleSoundGenerators_();var e=new i(this.audioContext_,t,this.waveType_,this.envelope_);this.singleSoundGenerators_.push(e),e.connect(this.gain_)}.bind(this)),t.on("remove",function(t){this.disposeFinishedSingleSoundGenerators_();for(var i=this.singleSoundGenerators_.length-1,n=!1;i>=0&&!n;i--)e.timeObjectsEqual(this.singleSoundGenerators_[i].timeObject,t)&&(n=!0,this.singleSoundGenerators_[i].dispose())}.bind(this))},t.module.SoundGenerator.prototype.pause=function(t){t=t||0,this.singleSoundGenerators_.forEach(function(t){t.dispose(!1)})},t.module.SoundGenerator.prototype.interrupt=function(){this.singleSoundGenerators_.forEach(function(t){t.dispose(!0)})},t.module.SoundGenerator.prototype.getWaveType=function(){return this.waveType_},t.module.SoundGenerator.prototype.setWaveType=function(t){this.waveType_=t,this.disposeFinishedSingleSoundGenerators_(),this.singleSoundGenerators_.forEach(function(e){e.setWaveType(t)})},t.module.SoundGenerator.prototype.getGain=function(){return this.gain_.gain.value},t.module.SoundGenerator.prototype.setGain=function(t){this.gain_.gain.value=t},t.module.SoundGenerator.prototype.updateTiming=function(){this.disposeFinishedSingleSoundGenerators_(),this.singleSoundGenerators_.forEach(function(t){t.updateTiming()})},t.module.SoundGenerator.prototype.getAttack=function(){return this.envelope_.attack},t.module.SoundGenerator.prototype.setAttack=function(t){this.envelope_.attack=t,this.updateTiming()},t.module.SoundGenerator.prototype.getDecay=function(){return this.envelope_.decay},t.module.SoundGenerator.prototype.setDecay=function(t){this.envelope_.decay=t,this.updateTiming()},t.module.SoundGenerator.prototype.getSustain=function(){return this.envelope_.sustain},t.module.SoundGenerator.prototype.setSustain=function(t){this.envelope_.sustain=t,this.updateTiming()},t.module.SoundGenerator.prototype.getRelease=function(){return this.envelope_.release},t.module.SoundGenerator.prototype.setRelease=function(t){this.envelope_.release=t,this.updateTiming()}}(),t.module.Gain=function(e,i){i=i||{},t.module.Module.call(this,e,i),this.gainNode_=e.createGain(),this.setGain(i.gain||1),this.input=this.output=this.gainNode_},t.inherits(t.module.Gain,t.module.Module),t.module.Gain.prototype.setGain=function(t){this.gainNode_.gain.value=t},t.module.Gain.prototype.getGain=function(){return this.gainNode_.gain.value},t.module.Amount=function(e,i){t.module.Module.call(this,e,i),i=i||{},this.wet_=this.audioContext_.createGain(),this.dry_=this.audioContext_.createGain(),this.setAmount(i.amount||0),this.input=this.audioContext_.createGain(),this.input.connect(this.dry_),this.output=this.audioContext_.createGain(),this.wet_.connect(this.output),this.dry_.connect(this.output)},t.inherits(t.module.Amount,t.module.Module),t.module.Amount.prototype.biConnectWetChain=function(t,e){this.input.connect(t),e.connect(this.wet_)},t.module.Amount.prototype.setAmount=function(t){this.amount_=t,this.wet_.gain.value=t,this.dry_.gain.value=1-t},t.module.Amount.prototype.getAmount=function(){return this.amount_},t.module.PassFilter=function(e,i){t.module.Module.call(this,e,i),i=i||{},this.filter_=this.audioContext_.createBiquadFilter(),this.amount_=new t.module.Amount(this.audioContext_,{amount:0}),this.amount_.biConnectWetChain(this.filter_,this.filter_),this.input=this.output=this.amount_},t.inherits(t.module.PassFilter,t.module.Module),t.module.PassFilter.prototype.getType=function(){return this.filter_.type},t.module.PassFilter.prototype.setType=function(t){this.filter_.type=t},t.module.PassFilter.prototype.getFrequency=function(){return this.filter_.frequency.value},t.module.PassFilter.prototype.setFrequency=function(t){this.filter_.frequency.value=t},t.module.PassFilter.prototype.getResonance=function(){return this.filter_.Q.value},t.module.PassFilter.prototype.setResonance=function(t){this.filter_.Q.value=t},t.module.PassFilter.prototype.getAmount=function(){return this.amount_.getAmount()},t.module.PassFilter.prototype.setAmount=function(t){return this.amount_.setAmount(t)},t.player=t.player||{},t.player.Player=function(){t.StateExchange.call(this),this.addExchangeObjectStateParameter("instrument",this.getInstrument,this.setInstrument)},t.inherits(t.player.Player,t.StateExchange),t.player.Player.prototype.getInstrument=function(){return this.instrument_},t.player.Player.prototype.setInstrument=function(t){this.instrument_=t},t.player.Player.prototype.playIntervall=t.abstractFunction,t.player.OneBarStepSequencer=function(e,i){t.player.Player.call(this),this.clock_=e,this.steps_=i.steps||4,this.baseNoteIndex_=i.baseNoteIndex||36,this.intervals_=i.intervals||t.scales.intervals.major,this.notes_=[];for(var n=0;n<this.steps_;n++)this.notes_.push([]);this.stepLength_=this.clock_.getBarLength()/this.steps_,this.clock_.on("tempoChange",function(t){this.getInstrument().changeTempo(t,this.clock_.currentTime()),this.stepLength_*=t}.bind(this)),this.nextBarTime_=0,this.clock_.on("nextBar",function(t,e){this.nextBarTime_=e,this.playBar(t,e)}.bind(this)),this.clock_.on("stop",function(t){this.getInstrument().pause(t)}.bind(this)),this.clock_.on("interrupt",function(){this.getInstrument().interrupt()}.bind(this))},t.inherits(t.player.OneBarStepSequencer,t.player.Player),t.StateExchange.addType("synth.player.OneBarStepSequencer",t.player.OneBarStepSequencer),t.player.OneBarStepSequencer.prototype.playBar=function(e,i){for(var n=0;n<this.steps_;n++)this.notes_[n].forEach(function(e){var s={time:i+n*this.stepLength_,duration:this.stepLength_,value:t.scales.getIndexOf(e,this.intervals_,this.baseNoteIndex_)};this.getInstrument().addNote(s)}.bind(this))},t.player.OneBarStepSequencer.prototype.addNote=function(e,i){if(this.notes_[e].push(i),this.clock_.started){var n={time:e*this.stepLength_,duration:this.stepLength_,value:t.scales.getIndexOf(i,this.intervals_,this.baseNoteIndex_)},s=this.clock_.getBarLength(),o=new t.TimeCollection(0,2*s);o.insert(_.cloneDeep(n)).timeAdd(-s).insert(_.cloneDeep(n)),this.getInstrument().addNotes(o.timeAdd(this.nextBarTime_))}},t.player.OneBarStepSequencer.prototype.removeNote=function(e,i){var n=this.notes_[e].indexOf(i);if(n>-1&&(this.notes_[e].splice(n,1),this.clock_.started)){var s={time:e*this.stepLength_,duration:this.stepLength_,value:t.scales.getIndexOf(i,this.intervals_,this.baseNoteIndex_)},o=this.clock_.getBarLength(),a=new t.TimeCollection(0,2*o);a.insert(_.cloneDeep(s)).timeAdd(-o).insert(_.cloneDeep(s)).timeAdd(this.nextBarTime_),this.getInstrument().removeNotes(a)}},t.player.OneBarStepSequencer.prototype.clear=function(){for(var t=this.steps_-1;t>=0;t--)for(var e=this.notes_[t].length-1;e>=0;e--)this.removeNote(t,this.notes_[t][e])},t.viewController=t.viewController||{},t.viewController.ViewController=function(t){t=t||{},this.$element_=$("<div>").addClass(this.className_),"$target"in t&&t.$target.append(this.$element_)},t.viewController.ViewController.prototype.get$Element=function(){return this.$element_},t.viewController.ViewController.prototype.set$Target=function(t){t.append(this.$element_)},t.Observable=function(t){t=t||{},this.EventListeners_=this.EventListeners_||{},this.customKey_=this.customKey_||0},t.Observable.prototype.registerEventType=function(t){this.EventListeners_[t]=[]},t.Observable.prototype.fireEvent=function(t,e){if(!(t in this.EventListeners_))throw"EventType: '"+t+"' doesn't exist!";for(var i=0;i<this.EventListeners_[t].length;i++){var n=this.EventListeners_[t][i],s=n.opt_this||this;"function"==typeof n.listener&&n.listener.apply(s,e),n.once&&(this.EventListeners_[t].splice(i,1),i--)}},t.Observable.prototype.on=function(t,e,i){if(t in this.EventListeners_){var n=this.customKey_++;return this.EventListeners_[t].push({listener:e,opt_this:i,once:!1,key:n}),{type:t,key:n}}throw"EventType: '"+t+"' doesn't exist!"},t.Observable.prototype.once=function(t,e,i){if(t in this.EventListeners_){var n=this.customKey_++;return this.EventListeners_[t].push({listener:e,opt_this:i,once:!0,key:n}),{type:t,key:n}}throw"EventType: '"+t+"' doesn't exist!"},t.Observable.prototype.un=function(t,e,i){if(!(t in this.EventListeners_))throw"EventType: '"+t+"' doesn't exist!";for(var n=0;n<this.EventListeners_[t].length;n++)this.EventListeners_[t][n].listener===e&&(this.EventListeners_[t].splice(n,1),n--)},t.Observable.prototype.unByKey=function(t){if(!("type"in t))throw"invalid key: '"+t+"'!";if(!(t.type in this.EventListeners_))throw"EventType: '"+t.type+"' doesn't exist!";for(var e=0;e<this.EventListeners_[t.type].length;e++)this.EventListeners_[t.type][e].key===t.key&&(this.EventListeners_[t.type].splice(e,1),e--)},t.html=t.html||{},t.html.NumberInputField=function(e){e=e||{},t.Observable.call(this),this.displayPrecision_=e.displayPrecision||2,this.registerEventType("input"),this.$element_=$("<input>"),this.setValue(e.initial||0);var i=null,n=function(t){i=this.$element_.val()}.bind(this),s=function(t){this.setValue(parseFloat(this.$element_.val()))}.bind(this),o=function(t){13===t.which?this.$element_.blur():27===t.which&&(this.$element_.val(i),this.$element_.blur())}.bind(this);this.$element_.on("focus",n),this.$element_.on("blur",s),this.$element_.on("keydown",o)},t.inherits(t.html.NumberInputField,t.Observable),t.html.NumberInputField.prototype.get$Element=function(){return this.$element_},t.html.NumberInputField.prototype.setValue=function(t){var e=this.value_;this.value_=t,this.$element_.val(t.toFixed(this.displayPrecision_)),this.fireEvent("input",[{oldValue:e,newValue:t}])},t.html.NumberInputField.prototype.getValue=function(){return this.value_},t.html.NumberInputFieldWithValueDrag=function(e){e=e||{},t.html.NumberInputField.call(this,e),this.resolution_=e.resolution||1;var i=!1,n=null;this.$element_.addClass("synth-input-camouflage");var s=function(t){i=!0,n=t.pageY}.bind(this),o=function(t){if(i){var e=n-t.pageY;this.setValue(parseFloat(this.$element_.val())+e*this.resolution_),n=t.pageY}}.bind(this),a=function(t){i&&(i=!1)};this.$element_.on("mousedown",s),$(document).on("mousemove",o),$(document).on("mouseup",a),this.$element_.on("touchstart",function(t){t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY,s(t)}),this.$element_.on("touchmove",function(t){t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY,onMouseMove_(t)}),this.$element_.on("touchend",a)},t.inherits(t.html.NumberInputFieldWithValueDrag,t.html.NumberInputField),t.svgs=t.svgs||{},t.svgs.play='<svg viewBox = "0 0 100 100" version = "1.1" class="synth-svg-play"><path d = "M 25 0 L 25 100 L 75 50 L 25 0"></svg>',t.svgs.stop='<svg viewBox = "0 0 100 100" version = "1.1" class="synth-svg-stop"><path d = "M 10 10 L 90 10 L 90 90 L 10 90 L 10 10"></svg>',t.viewController.Playback=function(e,i){i=i||{},this.clock_=e,this.className_=i.className||"synth-playback",this.classNameActive_="synth-active",t.viewController.ViewController.call(this,i);var n,s,o;n=$("<button>").addClass(this.className_+"-play").append(t.svgs.play),n.on("click",function(){this.clock_.started||this.clock_.start()}.bind(this)),this.$element_.append(n),this.clock_.on("start",function(){n.addClass(this.classNameActive_),s.removeClass(this.classNameActive_)}.bind(this)),s=$("<button>").addClass(this.className_+"-stop").append(t.svgs.stop),s.addClass(this.classNameActive_),s.on("click",function(){this.clock_.started?this.clock_.stop():this.clock_.interrupt()}.bind(this)),this.$element_.append(s),this.clock_.on("stop",function(){s.addClass(this.classNameActive_),n.removeClass(this.classNameActive_)}.bind(this)),$(document).on("keydown",function(t){32===t.which?(this.clock_.started?this.clock_.stop():this.clock_.start(),t.preventDefault()):27===t.which&&this.clock_.interrupt()}.bind(this)),o=$("<div>").addClass(this.className_+"-bpm");var a=new t.html.NumberInputFieldWithValueDrag({resolution:.7,displayPrecision:2});a.setValue(this.clock_.getBpM()),a.on("input",function(){this.clock_.setBpM(parseFloat(a.getValue()))}.bind(this)),this.clock_.on("tempoChange",function(){a.setValue(this.clock_.getBpM())}.bind(this)),o.append(a.get$Element()).append("BpM"),this.$element_.append(o)},t.inherits(t.viewController.Playback,t.viewController.ViewController),t.viewController.Sequencer=function(e,i,n,s){this.sequencer_=e,s=s||{},this.className_=s.className||"synth-sequencer",t.viewController.ViewController.call(this,s),this.classNameButton_=this.className_+"-button",this.classNameButtonActive_=this.classNameButton_+"-active",this.classNameRow_=this.className_+"-row",this.classNameColumn_=this.className_+"-column";for(var o=$("<div>").addClass(this.className_+"-buttons"),a=0;i>a;a++)for(var r=0;n>r;r++)(function(t,e){var n=$("<button>").addClass(this.classNameButton_).addClass(this.classNameColumn_+"-"+r).addClass(this.classNameRow_+"-"+a);n.on("click",function(){var s=!n.hasClass(this.classNameButtonActive_);n.toggleClass(this.classNameButtonActive_),s?this.sequencer_.addNote(e,i-t-1):this.sequencer_.removeNote(e,i-t-1)}.bind(this)),o.append(n)}).bind(this)(a,r);this.$element_.append(o);var l=$("<button>").addClass(this.className_+"-clear").text("Clear").on("click",function(){this.sequencer_.clear(),o.children().removeClass(this.classNameButtonActive_)}.bind(this));this.$element_.append(l)},t.inherits(t.viewController.Sequencer,t.viewController.ViewController),t.html=t.html||{},t.html.RotaryControl=function(e){e=e||{},t.Observable.call(this),this.registerEventType("change:value"),this.spareDegrees=90,this.resolution=.005,this.className_="rotary-control",this.classNameTitle_=this.className_+"-title",this.classNameSVG_=this.className_+"-svg",this.classNamePointer_=this.className_+"-pointer",this.classNameValueField_=this.className_+"-valuefield",this.$element_=$("<div>").addClass(this.className_),e.title&&this.$element_.append($("<div>").addClass(this.classNameTitle_).append(e.title)),this.strokeWidth_=8,this.radius_=26,this.pointerLength_=25,this.pointerDistanceFromCenter_=12,this.dotRadius=4,this.dotMinDistanceFromBorder_=2,this.$svg_=$('<svg viewBox = "0 0 100 100" version = "1.1"></svg>').attr("class",this.classNameSVG_),this.$element_.append(this.$svg_),this.$svg_.html('<circle cx="50" cy="50" r="'+this.radius_+'" stroke-width="'+this.strokeWidth_+'" fill="transparent" /><rect class="'+this.classNamePointer_+'" width="'+this.strokeWidth_+'" height="'+this.pointerLength_+'" x="'+(50-this.strokeWidth_/2)+'" y="'+(50+this.pointerDistanceFromCenter_)+'"/>');var i=this;this.$svg_.on("mousedown",function(t){i.onSVGMouseDown_(t)}),this.$svg_.on("touchstart",function(t){t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY,i.onSVGMouseDown_(t)}),$(document).on("mousemove",function(t){i.onDocMouseMove_(t)}),this.$svg_.on("touchmove",function(t){t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY,i.onDocMouseMove_(t)}),$(document).on("mouseup touchend",function(t){i.onDocMouseUp_(t)}),this.$valueField_=$('<input type="text" disabled>').addClass(this.classNameValueField_).addClass("synth-input-camouflage"),this.$element_.append($("<div>").append(this.$valueField_)),this.setPosition(0)},t.inherits(t.html.RotaryControl,t.Observable),t.html.RotaryControl.prototype.get$Element=function(){return this.$element_},t.html.RotaryControl.prototype.createDots_=function(){for(var t,e,i,n=0;n<this.dots_.length;n++)t=this.spareDegrees/2+(360-this.spareDegrees)*this.dots_[n],e=-Math.sin(t/360*2*Math.PI)*(50-this.dotMinDistanceFromBorder_-this.dotRadius)+50,i=Math.cos(t/360*2*Math.PI)*(50-this.dotMinDistanceFromBorder_-this.dotRadius)+50,this.$svg_.html(this.$svg_.html()+'<circle cx="'+e+'" cy="'+i+'" r="'+this.dotRadius+'" />')},t.html.RotaryControl.prototype.onSVGMouseDown_=function(t){this.mouseMove_=!0,this.lastY_=t.pageY,t.preventDefault()},t.html.RotaryControl.prototype.onDocMouseMove_=function(t){if(this.mouseMove_){var e=this.lastY_-t.pageY,i=Math.max(0,Math.min(this.position_+e*this.resolution,1));this.setPosition(i),this.lastY_=t.pageY}},t.html.RotaryControl.prototype.onDocMouseUp_=function(t){this.mouseMove_=!1},t.html.RotaryControl.prototype.getValue=function(){return this.value_},t.html.RotaryControl.prototype.setValue=function(t){var e=this.value_;this.value_=t,this.fireEvent("change:value",{oldValue:e})},t.html.RotaryControl.prototype.setPosition=function(t){this.position_=t;var e="rotate("+(this.spareDegrees/2+(360-this.spareDegrees)*t)+" 50 50)";this.$svg_.children("."+this.classNamePointer_).attr("transform",e),this.updateValueFromPosition()},t.html.AnalogRotaryControl=function(e){e=e||{},this.min_=e.min||0,this.max_=e.max||1,e.hasOwnProperty("logarithmic")&&e.logarithmic?(this.mappingFunction_=function(t){return this.min_/Math.E*Math.exp(Math.log(this.max_*Math.E/this.min_)*t)},this.inverseMappingFunction_=function(t){return Math.log(t*Math.E/this.min_)/Math.log(this.max_*Math.E/this.min_)}):(this.mappingFunction_=function(t){return this.min_+t*(this.max_-this.min_)},this.inverseMappingFunction_=function(t){return t/(this.max_-this.min_)-this.min_}),t.html.RotaryControl.call(this,e),this.dots_=[0,1],this.createDots_(),this.displayPrecision_=e.displayPrecision||2,this.unit_=e.unit||"",this.setEditable(e.editable||!0),this.setValue(Math.min(this.max_,Math.max(this.min_,e.initial||this.min_))),this.updatePositionFromValue()},t.inherits(t.html.AnalogRotaryControl,t.html.RotaryControl),t.html.AnalogRotaryControl.prototype.setValue=function(e){e=Math.min(this.max_,Math.max(this.min_,e)),t.html.RotaryControl.prototype.setValue.call(this,e);var i=e.toFixed(this.displayPrecision_);this.unit_&&(i+=" "+this.unit_),this.$valueField_.val(i)},t.html.AnalogRotaryControl.prototype.setEditable=function(t){this.editable_=t,this.editable_?(this.$valueField_.attr("disabled",!1),this.$valueField_.on("blur",function(t){var e=parseFloat(this.$valueField_.val());_.isNaN(e)||(this.setValue(e),this.updatePositionFromValue())}.bind(this)),this.$valueField_.on("keydown",function(t){13===t.which?this.$valueField_.blur():27===t.which&&(this.updateValueFromPosition(),this.$valueField_.blur())}.bind(this))):this.$valueField_.attr("disabled",!0)},t.html.AnalogRotaryControl.prototype.updateValueFromPosition=function(){this.setValue(this.mappingFunction_(this.position_))},t.html.AnalogRotaryControl.prototype.updatePositionFromValue=function(){this.setPosition(this.inverseMappingFunction_(this.value_))},t.html.DiscreteRotaryControl=function(e){e=e||{},this.valueIndex_=0,t.html.RotaryControl.call(this,e),this.setValueArray(e.values||[0,1]),this.setValue(e.initial||this.values_[0]),this.updatePositionFromValue()},t.inherits(t.html.DiscreteRotaryControl,t.html.RotaryControl),t.html.DiscreteRotaryControl.prototype.setValueArray=function(t){this.length_=t.length,this.values_=t,this.dots_=[];for(var e=0;e<this.length_;e++)this.dots_.push(1/(this.length_-1)*e);this.createDots_(),this.updateValueFromPosition()},t.html.DiscreteRotaryControl.prototype.updateValueFromPosition=function(){if(this.values_){var t=function(e,i){if(i-e>1){var n=e+Math.floor((i-e)/2);return this.position_<=this.dots_[n]?t(e,n):t(n,i)}return i-e===1?this.position_-this.dots_[e]<this.dots_[i]-this.position_?e:i:e}.bind(this);this.valueIndex_=t(0,this.length_-1),this.setValue(this.values_[this.valueIndex_]),this.$valueField_.val(this.getValue())}},t.html.DiscreteRotaryControl.prototype.updatePositionFromValue=function(){this.valueIndex_=this.values_.indexOf(this.getValue()),this.setPosition(this.dots_[this.valueIndex_])},t.html.DiscreteRotaryControl.prototype.onDocMouseUp_=function(e){this.mouseMove_&&this.setPosition(this.dots_[this.valueIndex_]),t.html.RotaryControl.prototype.onDocMouseUp_.call(this,e)},t.viewController.SoundGeneratorSimple=function(e,i){this.soundGenerator_=e,i=i||{},this.className_=i.className||"synth-module-soundgenerator-simple",t.viewController.ViewController.call(this,i);var n=new t.html.DiscreteRotaryControl({title:"Wave",values:["sine","square","sawtooth","triangle"],initial:e.getWaveType()});n.on("change:value",function(){this.soundGenerator_.setWaveType(n.getValue())}.bind(this));var s=new t.html.AnalogRotaryControl({title:"Gain",min:0,max:2,initial:e.getGain()});s.on("change:value",function(){this.soundGenerator_.setGain(s.getValue())}.bind(this)),this.$element_.append(n.get$Element()),this.$element_.append(s.get$Element())},t.inherits(t.viewController.SoundGeneratorSimple,t.viewController.ViewController),t.viewController.SoundGenerator=function(e,i){this.soundGenerator_=e,i=i||{},this.className_=i.className||"synth-module-soundgenerator",t.viewController.ViewController.call(this,i);var n=new t.html.DiscreteRotaryControl({title:"Wave",values:["sine","square","sawtooth","triangle"],initial:e.getWaveType()});n.on("change:value",function(){this.soundGenerator_.setWaveType(n.getValue())}.bind(this));var s=new t.html.AnalogRotaryControl({title:"Gain",min:.01,max:1,logarithmic:!0,displayPrecision:2,initial:e.getGain()});s.on("change:value",function(){this.soundGenerator_.setGain(s.getValue())}.bind(this));var o=new t.html.AnalogRotaryControl({title:"Attack",min:.01,max:10,logarithmic:!0,displayPrecision:2,unit:"s",initial:e.getAttack()});o.on("change:value",function(){this.soundGenerator_.setAttack(o.getValue())}.bind(this));var a=new t.html.AnalogRotaryControl({title:"Decay",min:.01,max:10,logarithmic:!0,displayPrecision:2,unit:"s",initial:e.getDecay()});a.on("change:value",function(){this.soundGenerator_.setDecay(a.getValue())}.bind(this));var r=new t.html.AnalogRotaryControl({title:"Sustain",min:0,max:1,displayPrecision:2,initial:e.getSustain()});r.on("change:value",function(){this.soundGenerator_.setSustain(r.getValue())}.bind(this));var l=new t.html.AnalogRotaryControl({title:"Release",min:.01,max:20,logarithmic:!0,displayPrecision:3,unit:"s",initial:e.getRelease()});l.on("change:value",function(){this.soundGenerator_.setRelease(l.getValue())}.bind(this)),this.$element_.append(n.get$Element()),this.$element_.append(s.get$Element()),this.$element_.append(o.get$Element()),this.$element_.append(a.get$Element()),this.$element_.append(r.get$Element()),this.$element_.append(l.get$Element())},t.inherits(t.viewController.SoundGenerator,t.viewController.ViewController),t.viewController.PassFilter=function(e,i){this.passFilter_=e,i=i||{},this.className_=i.className||"synth-module-passfilter",t.viewController.ViewController.call(this,i);var n=new t.html.DiscreteRotaryControl({title:"Type",values:["lowpass","highpass","bandpass"],initial:e.getType()});n.on("change:value",function(){this.passFilter_.setType(n.getValue())}.bind(this));var s=new t.html.AnalogRotaryControl({title:"Freq",min:100,max:1e3,logarithmic:!0,displayPrecision:0,initial:e.getFrequency()});s.on("change:value",function(){this.passFilter_.setFrequency(s.getValue())}.bind(this));var o=new t.html.AnalogRotaryControl({title:"Q",min:.01,max:10,logarithmic:!0,displayPrecision:0,initial:e.getResonance()});o.on("change:value",function(){this.passFilter_.setResonance(o.getValue())}.bind(this));var a=new t.html.AnalogRotaryControl({title:"Amount",min:0,max:1,initial:this.passFilter_.getAmount()});a.on("change:value",function(){this.passFilter_.setAmount(a.getValue())}.bind(this)),this.$element_.append(n.get$Element()),this.$element_.append(s.get$Element()),this.$element_.append(o.get$Element()),this.$element_.append(a.get$Element())},t.inherits(t.viewController.PassFilter,t.viewController.ViewController),t.viewController.Gain=function(e,i){this.gainModule_=e,
i=i||{},this.className_=i.className||"synth-module-gain",t.viewController.ViewController.call(this,i);var n=new t.html.AnalogRotaryControl({title:"Vol",min:.1,max:1,logarithmic:!0,initial:e.getGain()});n.on("change:value",function(){this.gainModule_.setGain(n.getValue())}.bind(this)),this.$element_.append(n.get$Element())},t.inherits(t.viewController.Gain,t.viewController.ViewController),t.scales={},function(){var e=function(t,e){for(var i=[],n=108,s=Math.pow(2,1/12),o=0;n>o;o++)i.push(e*Math.pow(s,o-t));return i};t.scales.getIndexOf=function(t,e,i){var n=e.reduce(function(t,e){return t+e}),s=Math.floor(t/n);return e.slice(0,t%e.length).reduce(function(t,e){return t+e},i+s*n)},t.scales.intervals={},t.scales.intervals.major=[2,2,1,2,2,2,1],t.scales.intervals.minor=[2,1,2,2,1,2,2],t.scales.intervals.minorGypsy=[2,1,3,2,1,3,1],t.scales.intervals.majorGypsy=[1,3,1,2,1,3,2],t.scales.intervals.bluesMinor=[3,2,1,1,3,2],t.scales.intervals.bluesMajor=[2,1,1,3,2,1,2],t.scales.frequencyTables={},t.scales.frequencyTables.a4is432Hz=e(57,432),t.scales.frequencyTables.a4is434Hz=e(57,434),t.scales.frequencyTables.a4is436Hz=e(57,436),t.scales.frequencyTables.a4is437Hz=e(57,438),t.scales.frequencyTables.a4is440Hz=e(57,440),t.scales.frequencyTables.a4is442Hz=e(57,442),t.scales.frequencyTables.a4is444Hz=e(57,444),t.scales.frequencyTables.a4is446Hz=e(57,446)}(),t.Clock=function(e){t.Observable.call(this),this.registerEventType("nextBar"),this.registerEventType("start"),this.registerEventType("stop"),this.registerEventType("tempoChange"),this.registerEventType("interrupt"),this.audioContext_=e,this.bpm_=120,this.minBpm_=20,this.maxBpm_=360,this.lookahead_=.5,this.started=!1,this.nextBar_=0,this.nextBarTime_=0},t.inherits(t.Clock,t.StateExchange),t.inherits(t.Clock,t.Observable),t.Clock.prototype.getBpM=function(){return this.bpm_},t.Clock.prototype.setBpM=function(t){if(t!==this.bpm_){var e=this.bpm_,i=this.getBarLength();if(this.bpm_=Math.min(this.maxBpm_,Math.max(this.minBpm_,t)),this.started){var n=this.nextBarTime_-i,s=(this.audioContext_.currentTime-n)/i;this.nextBarTime_=this.audioContext_.currentTime+(1-s)*this.getBarLength(),this.makeLoop_()}this.fireEvent("tempoChange",[e/t])}},t.Clock.prototype.getBarLength=function(){return 60/this.bpm_*4},t.Clock.prototype.start=function(t){t=t||this.audioContext_.currentTime,this.fireEvent("start",[t]),this.fireEvent("nextBar",[0,t]),this.nextBar_=1,this.nextBarTime_=t+this.getBarLength(),this.makeLoop_(t),this.started=!0},t.Clock.prototype.stop=function(t){setTimeout(function(){this.started=!1,clearTimeout(this.loopTimeout),this.fireEvent("stop",[t])}.bind(this),1e3*(t-this.audioContext_.currentTime))},t.Clock.prototype.interrupt=function(){this.stop(this.audioContext_.currentTime),this.fireEvent("interrupt")},t.Clock.prototype.makeLoop_=function(){clearTimeout(this.loopTimeout);var t=function(){this.fireEvent("nextBar",[this.nextBar_,this.nextBarTime_]),this.nextBar_++,this.nextBarTime_+=this.getBarLength(),this.loopTimeout=setTimeout(t,1e3*(this.nextBarTime_-this.audioContext_.currentTime-this.lookahead_))}.bind(this);this.loopTimeout=setTimeout(t,1e3*(this.nextBarTime_-this.audioContext_.currentTime-this.lookahead_))},t.Clock.prototype.currentTime=function(){return this.audioContext_.currentTime};var e=e||{};e.timeObjectsEqual=function(t,e){return t.time===e.time&&t.duration===e.duration&&t.value===e.value},t.TimeCollection=function(e,i,n){if(t.Observable.call(this),n=n||{},this.timeObjects_=[],this.count=0,_.isNaN(e)||_.isNaN(i))throw new Error("TimeCollection needs a begin and an end!");this.begin=e,this.end=i,this.registerEventType("insert"),this.registerEventType("remove"),this.registerEventType("objectChanged")},t.inherits(t.TimeCollection,t.Observable),t.TimeCollection.prototype.insert=function(t){return this.timeObjects_.push(t),this.count++,this.fireEvent("insert",[t]),this},t.TimeCollection.prototype.remove=function(t){for(var i=0,n=!1;i<this.count&&!n;i++)e.timeObjectsEqual(this.timeObjects_[i],t)&&(this.timeObjects_.splice(i,1),n=!0,this.count--,this.fireEvent("remove",[t]));return this},t.TimeCollection.prototype.forEach=function(t){this.timeObjects_.forEach(t)},t.TimeCollection.prototype.before=function(e,i){for(var n=new t.TimeCollection(this.begin,e),s=0;s<this.count;s++)this.timeObjects_[s].time+this.timeObjects_[s].duration<e?n.insert(this.timeObjects_[s]):i&&this.timeObjects_[s].time<e&&n.insert(this.timeObjects_[s]);return n},t.TimeCollection.prototype.beforeEqual=function(e,i){for(var n=new t.TimeCollection(this.begin,e),s=0;s<this.count;s++)this.timeObjects_[s].time+this.timeObjects_[s].duration<=e?n.insert(this.timeObjects_[s]):i&&this.timeObjects_[s].time<=e&&n.insert(this.timeObjects_[s]);return n},t.TimeCollection.prototype.after=function(e,i){for(var n=new t.TimeCollection(e,this.end),s=0;s<this.count;s++)this.timeObjects_[s].time>e?n.insert(this.timeObjects_[s]):i&&this.timeObjects_[s].time+this.timeObjects_[s].duration>e&&n.insert(this.timeObjects_[s]);return n},t.TimeCollection.prototype.afterEqual=function(e,i){for(var n=new t.TimeCollection(e,this.end),s=0;s<this.count;s++)this.timeObjects_[s].time>=e?n.insert(this.timeObjects_[s]):i&&this.timeObjects_[s].time+this.timeObjects_[s].duration>=e&&n.insert(this.timeObjects_[s]);return n},t.TimeCollection.prototype.clone=function(){var e=new t.TimeCollection(this.begin,this.end);return this.forEach(function(t){e.insert(_.cloneDeep(t))}),e},t.TimeCollection.prototype.timeAdd=function(t){return this.begin+=t,this.end+=t,this.forEach(function(e){var i=_.cloneDeep(e);e.time+=t,this.fireEvent("objectChanged",[{old:i,"new":e}])}.bind(this)),this},t.TimeCollection.prototype.timeMultiply=function(t){return this.begin*=t,this.end*=t,this.forEach(function(e){e.time*=t,this.fireEvent("objectChanged",[e])}.bind(this)),this},t.TimeCollection.prototype.sort=function(){var e=new t.TimeCollection(this.begin,this.end);return _.sortBy(this.timeObjects_,"time").forEach(function(t){e.insert(t)}),e},t.TimeCollection.prototype.atTime=function(e){var i=new t.TimeCollection(this.begin,this.end);return this.forEach(function(t){t.time<=e&&t.time+t.duration>=e&&i.insert(t)}),i},t.TimeCollection.prototype.contains=function(t){var e=!1;return this.forEach(function(i){i.time===t.time&&i.duration===t.duration&&i.value===t.value&&(e=!0)}),e},t.debuggers={},t.debuggers.debugCollection=function(t){{var e=$("<table>");$()}$("body").append(e),e.append($("<thead>").append($("<tr>").append($("<th>").text("Time")).append($("<th>").text("Duration")).append($("<th>").text("Value")))),e.append("<tbody>");var i=function(){e.children("tbody").empty(),t.sort().forEach(function(t){$row=$("<tr>").append($("<td>").append(t.time)).append($("<td>").append(t.duration)).append($("<td>").append(t.value)),e.children("tbody").append($row)})},n=setInterval(i,50),s=!1;$(document).on("keydown",function(t){27===t.which&&(s=!s,s?clearInterval(n):n=setInterval(i,50))})},t.debuggers.debugTime=function(t){$showTime=$("<span>"),$("body").append($("<div>").append("currentTime: ").append($showTime));var e=function(){$showTime.text(t.currentTime)},i=setInterval(e,50),n=!1;$(document).on("keydown",function(t){27===t.which&&(n=!n,n?clearInterval(i):i=setInterval(e,50))})}}();